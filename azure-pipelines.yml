name: Deploy bicep files

trigger:
- master

pool:
  name: local_pool
  demands:
    - agent.os -equals Darwin

stages:
# Run linting on the bicep file, warnings are shown but this doesn't stop the pipeline. Errors do
- stage: Lint
  jobs:
    - template: templates/lint.yml

# Run validation on the deployment subscription
- stage: Validate
  jobs:
    - template: templates/validate.yml

# Run what if statement
- stage: Preview
  jobs: 
  - job: PreviewAzureChanges
    displayName: Preview Azure changes
    steps:
      - task: AzureCLI@2
        name: RunWhatIf
        displayName: Run what-if
        inputs:
          azureSubscription: $(AZURE_SUBSCRIPTION)
          scriptType: 'bash'
          scriptLocation: 'inlineScript'
          inlineScript: |
            az deployment sub what-if \
               --template-file $(Build.SourcesDirectory)/main.bicep \
              -l northeurope \
              --no-prompt \
              --parameters contributor_object_id=$(CONTRIBUTOR_OBJECT_ID) \
                            azure_client_id=$(AZURE_CLIENT_ID) \
                            azure_client_secret=$(AZURE_CLIENT_SECRET) \
                            azure_tenant_id=$(AZURE_TENANT_ID) \
                            resource_group=$(RESOURCE_GROUP) \
              --parameters @main.parameters.json

# Lastly deploy the bicep file code to Azure
- stage: Deploy
  jobs:
    - template: templates/deploy.yml
  